#!/usr/bin/env python3
"""
Whisperè‡ªå‹•æ–‡å­—èµ·ã“ã—ã‚·ã‚¹ãƒ†ãƒ 

ã€ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å½¹å‰²ã€‘
inputãƒ•ã‚©ãƒ«ãƒ€ã‚’ç›£è¦–ã—ã¦ã€æ–°ã—ã„.m4aãƒ•ã‚¡ã‚¤ãƒ«ãŒè¿½åŠ ã•ã‚ŒãŸã‚‰è‡ªå‹•çš„ã«æ–‡å­—èµ·ã“ã—ã—ã¾ã™ã€‚
MacBook Pro M4ã§é«˜é€Ÿã«å‹•ä½œã™ã‚‹ã‚ˆã†ã«æœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã€ç‰¹å¾´ã€‘
- ãƒ•ã‚©ãƒ«ãƒ€ç›£è¦–ã«ã‚ˆã‚‹å®Œå…¨è‡ªå‹•åŒ–ï¼ˆWatchdogä½¿ç”¨ï¼‰
- 3æ™‚é–“ä»¥ä¸Šã®é•·æ™‚é–“éŸ³å£°ã«ã‚‚å¯¾å¿œï¼ˆ10åˆ†ã”ã¨ã«åˆ†å‰²å‡¦ç†ï¼‰
- é‡è¤‡å‡¦ç†é˜²æ­¢
- ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€å®Œäº†å¾…æ©Ÿï¼ˆAirDropã‚„ã‚³ãƒ”ãƒ¼ä¸­ã®å•é¡Œã«å¯¾å¿œï¼‰
- è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

ã€ä½¿ã„æ–¹ã€‘
1. python transcribe_auto.py ã‚’å®Ÿè¡Œ
2. input/ ãƒ•ã‚©ãƒ«ãƒ€ã« .m4a ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
3. è‡ªå‹•çš„ã«æ–‡å­—èµ·ã“ã—ãŒé–‹å§‹ã•ã‚Œã€output/ ãƒ•ã‚©ãƒ«ãƒ€ã«çµæœãŒä¿å­˜ã•ã‚Œã‚‹
4. åœæ­¢ã™ã‚‹ã«ã¯ Ctrl+C ã‚’æŠ¼ã™
"""

# ============================================================
# å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆèª­ã¿è¾¼ã‚€ï¼‰
# ============================================================

import os                          # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ•ã‚©ãƒ«ãƒ€æ“ä½œã«ä½¿ã†
import sys                         # ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®çµ‚äº†ãªã©ã«ä½¿ã†
import time                        # æ™‚é–“ã‚’æ‰±ã†ï¼ˆå¾…æ©Ÿãªã©ï¼‰
import signal                      # Ctrl+Cã‚’æ¤œçŸ¥ã™ã‚‹ãŸã‚ã«ä½¿ã†
import argparse                    # ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’æ‰±ã†
from pathlib import Path           # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æ‰±ã„ã‚„ã™ãã™ã‚‹
from datetime import datetime      # æ—¥ä»˜ã¨æ™‚åˆ»ã‚’æ‰±ã†

# Whisperï¼ˆOpenAIã®éŸ³å£°èªè­˜AIï¼‰
import whisper

# éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ãƒ»å¤‰æ›
from pydub import AudioSegment

# AIè¨ˆç®—ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆPyTorchï¼‰
import torch

# ãƒ•ã‚©ãƒ«ãƒ€ç›£è¦–ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆWatchdogï¼‰
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler


# ============================================================
# è¨­å®šï¼ˆå®šæ•°ï¼‰
# ============================================================

INPUT_DIR = "input"                    # ç›£è¦–ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆã“ã“ã«éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¥ã‚Œã‚‹ï¼‰
OUTPUT_DIR = "output"                  # çµæœã‚’ä¿å­˜ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€
CHUNK_LENGTH_MS = 10 * 60 * 1000      # 10åˆ†ã”ã¨ã«åˆ†å‰²ï¼ˆ1000ãƒŸãƒªç§’ = 1ç§’ï¼‰
                                       # ãªãœåˆ†å‰²ï¼Ÿâ†’ é•·ã„éŸ³å£°ã‚’ä¸€åº¦ã«å‡¦ç†ã™ã‚‹ã¨
                                       #             ãƒ¡ãƒ¢ãƒªï¼ˆRAMï¼‰ãŒè¶³ã‚Šãªããªã‚‹ãŸã‚


# ============================================================
# ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ï¼ˆè£œåŠ©çš„ãªå‡¦ç†ï¼‰
# ============================================================

def setup_directories():
    """
    å…¥åŠ›ãƒ»å‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã™ã‚‹é–¢æ•°

    ã€ã‚„ã‚‹ã“ã¨ã€‘
    - inputãƒ•ã‚©ãƒ«ãƒ€ãŒãªã‘ã‚Œã°ä½œã‚‹
    - outputãƒ•ã‚©ãƒ«ãƒ€ãŒãªã‘ã‚Œã°ä½œã‚‹
    - ã™ã§ã«ã‚ã‚Œã°ä½•ã‚‚ã—ãªã„ï¼ˆexist_ok=Trueï¼‰
    """
    Path(INPUT_DIR).mkdir(exist_ok=True)   # inputãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
    Path(OUTPUT_DIR).mkdir(exist_ok=True)  # outputãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ


def convert_audio_to_chunks(audio_path, chunk_length_ms=CHUNK_LENGTH_MS):
    """
    éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å°ã•ãªå¡Šï¼ˆãƒãƒ£ãƒ³ã‚¯ï¼‰ã«åˆ†å‰²ã™ã‚‹é–¢æ•°

    ã€ãªãœåˆ†å‰²ã™ã‚‹ã®ï¼Ÿã€‘
    é•·ã„éŸ³å£°ã‚’ä¸€åº¦ã«å‡¦ç†ã™ã‚‹ã¨ã€ãƒ¡ãƒ¢ãƒªï¼ˆRAMï¼‰ãŒè¶³ã‚Šãªããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
    ä¾‹ãˆã°ã€3æ™‚é–“ã®éŸ³å£°ã‚’10åˆ†ãšã¤ã«åˆ†å‰²ã™ã‚Œã°ã€ãƒ¡ãƒ¢ãƒªã‚’ç¯€ç´„ã§ãã¾ã™ã€‚

    ã€å¼•æ•°ã€‘
        audio_path: éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ï¼ˆä¾‹: input/meeting.m4aï¼‰
        chunk_length_ms: 1ã¤ã®ãƒãƒ£ãƒ³ã‚¯ã®é•·ã•ï¼ˆãƒŸãƒªç§’ï¼‰
                        ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯10åˆ† = 600,000ãƒŸãƒªç§’

    ã€æˆ»ã‚Šå€¤ã€‘
        åˆ†å‰²ã•ã‚ŒãŸéŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒˆï¼ˆä¾‹: [0-10åˆ†, 10-20åˆ†, 20-30åˆ†, ...]ï¼‰
    """
    print(f"   éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­: {audio_path.name}")
    # m4aå½¢å¼ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
    audio = AudioSegment.from_file(str(audio_path), format="m4a")

    # éŸ³å£°ã®é•·ã•ã‚’è¨ˆç®—
    duration_ms = len(audio)            # ãƒŸãƒªç§’å˜ä½ã§é•·ã•ã‚’å–å¾—
    duration_min = duration_ms / 1000 / 60  # åˆ†ã«å¤‰æ›ï¼ˆÃ·1000ã§ç§’ã€Ã·60ã§åˆ†ï¼‰
    print(f"   éŸ³å£°ã®é•·ã•: {duration_min:.1f}åˆ†")

    # ============================================================
    # éŸ³å£°ã‚’ãƒãƒ£ãƒ³ã‚¯ï¼ˆå¡Šï¼‰ã«åˆ†å‰²
    # ============================================================
    chunks = []  # åˆ†å‰²ã—ãŸéŸ³å£°ã‚’å…¥ã‚Œã‚‹ãƒªã‚¹ãƒˆ

    # ä¾‹: 30åˆ†ã®éŸ³å£°ã‚’10åˆ†ã”ã¨ã«åˆ†å‰²
    #     i = 0, 600000, 1200000 ã®ã‚ˆã†ã«é€²ã‚€
    for i in range(0, duration_ms, chunk_length_ms):
        # i ã‹ã‚‰ i+chunk_length_ms ã¾ã§ã®éƒ¨åˆ†ã‚’åˆ‡ã‚Šå‡ºã™
        # ä¾‹: audio[0:600000] â†’ æœ€åˆã®10åˆ†
        chunk = audio[i:i + chunk_length_ms]
        chunks.append(chunk)  # ãƒªã‚¹ãƒˆã«è¿½åŠ 

    print(f"   {len(chunks)}å€‹ã®ãƒãƒ£ãƒ³ã‚¯ã«åˆ†å‰²ã—ã¾ã—ãŸ")
    return chunks


def transcribe_audio(audio_path, model_name="base", language="ja"):
    """
    éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ–‡å­—èµ·ã“ã—ã™ã‚‹é–¢æ•°ï¼ˆã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼‰

    ã€ã‚„ã‚‹ã“ã¨ã€‘
    1. AIãƒ¢ãƒ‡ãƒ«ï¼ˆWhisperï¼‰ã‚’èª­ã¿è¾¼ã‚€
    2. éŸ³å£°ã‚’10åˆ†ã”ã¨ã«åˆ†å‰²
    3. ãã‚Œãã‚Œã®å¡Šã‚’æ–‡å­—èµ·ã“ã—
    4. å…¨éƒ¨ã¤ãªã’ã¦è¿”ã™

    ã€å¼•æ•°ã€‘
        audio_path: éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ï¼ˆä¾‹: input/lecture.m4aï¼‰
        model_name: Whisperãƒ¢ãƒ‡ãƒ«å
                   - tiny: ä¸€ç•ªé€Ÿã„ã‘ã©ç²¾åº¦ä½ã‚
                   - base: ãƒãƒ©ãƒ³ã‚¹å‹ï¼ˆãŠã™ã™ã‚ï¼‰
                   - small: ã‚„ã‚„é«˜ç²¾åº¦
                   - medium: é«˜ç²¾åº¦ã ã‘ã©é…ã„
                   - large: æœ€é«˜ç²¾åº¦ã ã‘ã©ã¨ã¦ã‚‚é…ã„
        language: è¨€èªã‚³ãƒ¼ãƒ‰ï¼ˆja=æ—¥æœ¬èªã€en=è‹±èªï¼‰

    ã€æˆ»ã‚Šå€¤ã€‘
        æ–‡å­—èµ·ã“ã—çµæœã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå…¨æ–‡ï¼‰
    """

    # ============================================================
    # ã©ã®ãƒ‡ãƒã‚¤ã‚¹ï¼ˆå‡¦ç†è£…ç½®ï¼‰ã§è¨ˆç®—ã™ã‚‹ã‹æ±ºã‚ã‚‹
    # ============================================================

    # M4ãƒãƒƒãƒ—ï¼ˆApple Siliconï¼‰ãŒä½¿ãˆã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if torch.backends.mps.is_available():
        device = "mps"  # MPS = Metal Performance Shadersï¼ˆAppleã®é«˜é€Ÿè¨ˆç®—ï¼‰
        print(f"   M4ãƒãƒƒãƒ—ï¼ˆMPSï¼‰ã‚’ä½¿ç”¨ã—ã¦é«˜é€Ÿå‡¦ç†ã—ã¾ã™")
    # NVIDIA GPUãŒä½¿ãˆã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    elif torch.cuda.is_available():
        device = "cuda"  # CUDA = NVIDIAã®GPUè¨ˆç®—
        print(f"   CUDAï¼ˆGPUï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™")
    # ã©ã¡ã‚‰ã‚‚ä½¿ãˆãªã„å ´åˆã¯CPU
    else:
        device = "cpu"
        print(f"   CPUã‚’ä½¿ç”¨ã—ã¾ã™")

    # ============================================================
    # Whisperï¼ˆAIéŸ³å£°èªè­˜ãƒ¢ãƒ‡ãƒ«ï¼‰ã‚’èª­ã¿è¾¼ã‚€
    # ============================================================

    print(f"   Whisperãƒ¢ãƒ‡ãƒ«ï¼ˆ{model_name}ï¼‰ã‚’èª­ã¿è¾¼ã¿ä¸­...")
    model = whisper.load_model(model_name, device=device)

    # ============================================================
    # éŸ³å£°ã‚’ãƒãƒ£ãƒ³ã‚¯ï¼ˆå¡Šï¼‰ã«åˆ†å‰²
    # ============================================================

    chunks = convert_audio_to_chunks(audio_path)

    # ============================================================
    # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
    # ============================================================
    # ãªãœå¿…è¦ï¼Ÿâ†’ Whisperã¯éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€
    #           ãƒ¡ãƒ¢ãƒªä¸Šã®éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€åº¦ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã™ã‚‹

    temp_dir = Path("temp")               # tempãƒ•ã‚©ãƒ«ãƒ€
    temp_dir.mkdir(exist_ok=True)         # ãªã‘ã‚Œã°ä½œæˆ

    all_transcriptions = []  # æ–‡å­—èµ·ã“ã—çµæœã‚’å…¥ã‚Œã‚‹ãƒªã‚¹ãƒˆ

    # ============================================================
    # å„ãƒãƒ£ãƒ³ã‚¯ã‚’æ–‡å­—èµ·ã“ã—ï¼ˆã“ã“ãŒä¸€ç•ªé‡è¦ï¼ï¼‰
    # ============================================================

    print()
    # enumerate() ã¯ç•ªå·ä»˜ãã§ç¹°ã‚Šè¿”ã™
    # ä¾‹: [(0, chunk1), (1, chunk2), (2, chunk3)]
    for idx, chunk in enumerate(chunks):
        print(f"   ãƒãƒ£ãƒ³ã‚¯ {idx + 1}/{len(chunks)} ã‚’å‡¦ç†ä¸­...")

        # ------------------------------------------------------------
        # 1. ãƒãƒ£ãƒ³ã‚¯ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜
        # ------------------------------------------------------------
        temp_file = temp_dir / f"temp_chunk_{idx}.wav"  # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å
        chunk.export(str(temp_file), format="wav")      # wavå½¢å¼ã§ä¿å­˜

        # ------------------------------------------------------------
        # 2. Whisperã§æ–‡å­—èµ·ã“ã—å®Ÿè¡Œ
        # ------------------------------------------------------------
        result = model.transcribe(
            str(temp_file),      # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
            language=language,   # è¨€èªï¼ˆæ—¥æœ¬èªãªã‚‰ "ja"ï¼‰
            verbose=False        # è©³ç´°ãªãƒ­ã‚°ã‚’è¡¨ç¤ºã—ãªã„
        )

        # æ–‡å­—èµ·ã“ã—çµæœã‚’è¿½åŠ 
        # result["text"] ã«æ–‡å­—èµ·ã“ã—ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆãŒå…¥ã£ã¦ã„ã‚‹
        all_transcriptions.append(result["text"])

        # ------------------------------------------------------------
        # 3. ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ï¼ˆã‚‚ã†ä½¿ã‚ãªã„ã®ã§ï¼‰
        # ------------------------------------------------------------
        temp_file.unlink()  # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤

        # ------------------------------------------------------------
        # 4. é€²æ—ã‚’è¡¨ç¤º
        # ------------------------------------------------------------
        progress = (idx + 1) / len(chunks) * 100  # ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã‚’è¨ˆç®—
        print(f"   é€²æ—: {progress:.1f}%")

    # ============================================================
    # ä¸€æ™‚ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤ï¼ˆç©ºã«ãªã£ãŸã®ã§ï¼‰
    # ============================================================

    try:
        temp_dir.rmdir()  # ç©ºã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤
    except:
        pass  # ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã‚‚ç„¡è¦–ï¼ˆæ®‹ã£ã¦ã¦ã‚‚OKï¼‰

    # ============================================================
    # å…¨ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’1ã¤ã«ã¤ãªã’ã‚‹
    # ============================================================
    # ä¾‹: ["ã“ã‚“ã«ã¡ã¯", "ä»Šæ—¥ã¯"] â†’ "ã“ã‚“ã«ã¡ã¯\nä»Šæ—¥ã¯"

    full_transcription = "\n".join(all_transcriptions)

    print(f"   æ–‡å­—èµ·ã“ã—å®Œäº†!")
    print(f"   æ–‡å­—æ•°: {len(full_transcription)}æ–‡å­—")

    return full_transcription


def save_transcription(text, original_filename, output_dir=OUTPUT_DIR):
    """
    æ–‡å­—èµ·ã“ã—çµæœã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã™ã‚‹é–¢æ•°

    ã€ã‚„ã‚‹ã“ã¨ã€‘
    1. å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä½œã‚‹
    2. æ—¥ä»˜ã¨æ™‚åˆ»ã‚’è¿½åŠ ï¼ˆåŒã˜åå‰ã§ã‚‚ä¸Šæ›¸ãã•ã‚Œãªã„ã‚ˆã†ã«ï¼‰
    3. ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜

    ã€å¼•æ•°ã€‘
        text: æ–‡å­—èµ·ã“ã—çµæœã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå…¨æ–‡ï¼‰
        original_filename: å…ƒã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆä¾‹: "meeting.m4a"ï¼‰
        output_dir: ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: "output"ï¼‰

    ã€æˆ»ã‚Šå€¤ã€‘
        ä¿å­˜ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ï¼ˆä¾‹: output/meeting_20250130_153000.txtï¼‰
    """

    # ============================================================
    # å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
    # ============================================================

    # .stem = æ‹¡å¼µå­ã‚’é™¤ã„ãŸãƒ•ã‚¡ã‚¤ãƒ«å
    # ä¾‹: "meeting.m4a" â†’ "meeting"
    base_name = Path(original_filename).stem

    # ç¾åœ¨ã®æ—¥ä»˜ã¨æ™‚åˆ»ã‚’å–å¾—ï¼ˆä¾‹: "20250130_153000"ï¼‰
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")

    # ãƒ•ã‚¡ã‚¤ãƒ«åã‚’çµ„ã¿ç«‹ã¦ã‚‹
    # ä¾‹: "meeting_20250130_153000.txt"
    output_filename = f"{base_name}_{timestamp}.txt"
    output_path = Path(output_dir) / output_filename  # ãƒ•ãƒ«ãƒ‘ã‚¹

    # ============================================================
    # ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    # ============================================================

    # "w" = æ›¸ãè¾¼ã¿ãƒ¢ãƒ¼ãƒ‰ã€encoding="utf-8" = æ—¥æœ¬èªå¯¾å¿œ
    with open(output_path, "w", encoding="utf-8") as f:
        # ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã‚’æ›¸ãè¾¼ã‚€
        f.write(f"# æ–‡å­—èµ·ã“ã—çµæœ\n")
        f.write(f"å…ƒãƒ•ã‚¡ã‚¤ãƒ«: {original_filename}\n")
        f.write(f"ä½œæˆæ—¥æ™‚: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
        f.write(f"\n{'='*60}\n\n")

        # æ–‡å­—èµ·ã“ã—çµæœã‚’æ›¸ãè¾¼ã‚€
        f.write(text)

    return output_path


# ============================================================
# ãƒ•ã‚©ãƒ«ãƒ€ç›£è¦–ã®ãŸã‚ã®ã‚¯ãƒ©ã‚¹ï¼ˆè¨­è¨ˆå›³ï¼‰
# ============================================================

class AudioFileHandler(FileSystemEventHandler):
    """
    éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®è¿½åŠ ã‚’æ¤œçŸ¥ã—ã¦ã€è‡ªå‹•çš„ã«æ–‡å­—èµ·ã“ã—ã‚’å®Ÿè¡Œã™ã‚‹ã‚¯ãƒ©ã‚¹

    ã€ã‚¯ãƒ©ã‚¹ã¨ã¯ã€‘
    è¤‡æ•°ã®æ©Ÿèƒ½ï¼ˆé–¢æ•°ï¼‰ã‚’ã¾ã¨ã‚ãŸã‚‚ã®ã€‚æ–™ç†ã®ãƒ¬ã‚·ãƒ”é›†ã®ã‚ˆã†ãªã‚‚ã®ã€‚
    ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã€Œæ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¿½åŠ ã•ã‚ŒãŸã‚‰æ–‡å­—èµ·ã“ã—ã™ã‚‹ã€ã¨ã„ã†ãƒ¬ã‚·ãƒ”ã€‚
    """

    def __init__(self, model_name="base", language="ja"):
        """
        åˆæœŸè¨­å®šï¼ˆã“ã®ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã„å§‹ã‚ã‚‹ã¨ãã«æœ€åˆã«å®Ÿè¡Œã•ã‚Œã‚‹ï¼‰

        å¼•æ•°ï¼ˆææ–™ï¼‰:
            model_name: Whisperã®ãƒ¢ãƒ‡ãƒ«åï¼ˆç²¾åº¦ã¨é€Ÿåº¦ã®ãƒãƒ©ãƒ³ã‚¹ï¼‰
            language: è¨€èªï¼ˆæ—¥æœ¬èªã¯ "ja"ï¼‰
        """
        super().__init__()  # è¦ªã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–ï¼ˆãŠã¾ã˜ãªã„ï¼‰
        self.model_name = model_name    # ãƒ¢ãƒ‡ãƒ«åã‚’ä¿å­˜
        self.language = language        # è¨€èªã‚’ä¿å­˜
        self.processing_files = set()   # ç¾åœ¨å‡¦ç†ä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨˜éŒ²ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰

    def on_created(self, event):
        """
        æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚ŒãŸã¨ãã«è‡ªå‹•çš„ã«å‘¼ã°ã‚Œã‚‹é–¢æ•°

        ã€ã‚¤ãƒ™ãƒ³ãƒˆã¨ã¯ã€‘
        ã€Œä½•ã‹ãŒèµ·ããŸã¨ãã€ã®ã“ã¨ã€‚ã“ã®é–¢æ•°ã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œã‚‰ã‚ŒãŸã¨ãã€ã«
        è‡ªå‹•çš„ã«å®Ÿè¡Œã•ã‚Œã‚‹ã€‚

        å¼•æ•°:
            event: ä½•ãŒèµ·ããŸã‹ã®æƒ…å ±ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åãªã©ï¼‰
        """

        # ãƒ•ã‚©ãƒ«ãƒ€ã¯ç„¡è¦–ã™ã‚‹ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ã‚’å‡¦ç†ã—ãŸã„ï¼‰
        if event.is_directory:
            return

        # è¿½åŠ ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’å–å¾—
        file_path = Path(event.src_path)

        # .m4aãƒ•ã‚¡ã‚¤ãƒ«ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
        # ï¼ˆ.suffixã¯ãƒ•ã‚¡ã‚¤ãƒ«ã®æ‹¡å¼µå­ã‚’å–å¾—ã™ã‚‹ã€‚ä¾‹: "audio.m4a" â†’ ".m4a"ï¼‰
        if file_path.suffix.lower() != ".m4a":
            return  # .m4aã§ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„

        # ã™ã§ã«å‡¦ç†ä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç„¡è¦–ã™ã‚‹ï¼ˆäºŒé‡å‡¦ç†ã‚’é˜²ãï¼‰
        if str(file_path) in self.processing_files:
            return

        # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå®Œå…¨ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã¾ã§å°‘ã—å¾…ã¤
        # ï¼ˆå¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚³ãƒ”ãƒ¼ã«æ™‚é–“ãŒã‹ã‹ã‚‹ãŸã‚ï¼‰
        print(f"\nğŸ” æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡º: {file_path.name}")
        print("   ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿä¸­...")
        time.sleep(2)  # 2ç§’å¾…ã¤

        # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå®Œå…¨ã«ã‚³ãƒ”ãƒ¼ã•ã‚ŒãŸã‹ç¢ºèª
        if not self._wait_for_file_ready(file_path):
            print(f"âš ï¸  ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™ãŒã§ãã¾ã›ã‚“ã§ã—ãŸ: {file_path.name}")
            return

        # æ–‡å­—èµ·ã“ã—ã‚’é–‹å§‹
        self._process_audio_file(file_path)

    def _wait_for_file_ready(self, file_path, max_wait=30):
        """
        ãƒ•ã‚¡ã‚¤ãƒ«ãŒå®Œå…¨ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã¾ã§å¾…ã¤é–¢æ•°

        ã€ãªãœå¿…è¦ï¼Ÿã€‘
        å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€inputãƒ•ã‚©ãƒ«ãƒ€ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ã®ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã€‚
        ã‚³ãƒ”ãƒ¼ä¸­ã«æ–‡å­—èµ·ã“ã—ã‚’å§‹ã‚ã‚‹ã¨å¤±æ•—ã™ã‚‹ã®ã§ã€å®Œå…¨ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã¾ã§å¾…ã¤ã€‚

        å¼•æ•°:
            file_path: ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
            max_wait: æœ€å¤§ã§ä½•ç§’å¾…ã¤ã‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ30ç§’ï¼‰

        æˆ»ã‚Šå€¤:
            True: ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™ãŒã§ããŸ
            False: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆæ™‚é–“åˆ‡ã‚Œï¼‰
        """
        start_time = time.time()  # é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²
        last_size = -1            # å‰å›ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºï¼ˆæœ€åˆã¯-1ï¼‰
        stable_count = 0          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤‰ã‚ã‚‰ãªã‹ã£ãŸå›æ•°

        while True:
            # æ™‚é–“åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯
            if time.time() - start_time > max_wait:
                return False  # 30ç§’çµŒã£ã¦ã‚‚æº–å‚™ã§ããªã‹ã£ãŸã‚‰è«¦ã‚ã‚‹

            # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if not file_path.exists():
                time.sleep(0.5)  # 0.5ç§’å¾…ã£ã¦å†ãƒã‚§ãƒƒã‚¯
                continue

            try:
                # ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’å–å¾—
                current_size = file_path.stat().st_size

                # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤‰ã‚ã£ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
                if current_size == last_size:
                    stable_count += 1  # å¤‰ã‚ã£ã¦ã„ãªã„ â†’ ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
                    # 3å›é€£ç¶šã§åŒã˜ã‚µã‚¤ã‚ºãªã‚‰ã€ã‚³ãƒ”ãƒ¼å®Œäº†ã¨åˆ¤æ–­
                    if stable_count >= 3:
                        return True
                else:
                    # ã‚µã‚¤ã‚ºãŒå¤‰ã‚ã£ãŸ â†’ ã¾ã ã‚³ãƒ”ãƒ¼ä¸­
                    stable_count = 0
                    last_size = current_size

                time.sleep(0.5)  # 0.5ç§’å¾…ã£ã¦å†ãƒã‚§ãƒƒã‚¯

            except Exception as e:
                # ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã‚‰0.5ç§’å¾…ã£ã¦å†ãƒã‚§ãƒƒã‚¯
                time.sleep(0.5)
                continue

    def _process_audio_file(self, file_path):
        """
        éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ–‡å­—èµ·ã“ã—ã™ã‚‹é–¢æ•°

        å¼•æ•°:
            file_path: æ–‡å­—èµ·ã“ã—ã™ã‚‹éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
        """
        # å‡¦ç†ä¸­ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆäºŒé‡å‡¦ç†ã‚’é˜²ãï¼‰
        self.processing_files.add(str(file_path))

        try:
            print()
            print("=" * 60)
            print(f"å‡¦ç†é–‹å§‹: {file_path.name}")
            print("=" * 60)

            # æ–‡å­—èµ·ã“ã—å®Ÿè¡Œ
            print("ğŸ¤ æ–‡å­—èµ·ã“ã—ä¸­... ï¼ˆæ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰")
            transcription = transcribe_audio(
                file_path,
                model_name=self.model_name,
                language=self.language
            )

            # çµæœã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
            output_path = save_transcription(transcription, file_path.name)

            print()
            print(f"âœ… å®Œäº†: {output_path.name}")
            print("=" * 60)
            print()
            print("ğŸ‘€ æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾…ã£ã¦ã„ã¾ã™...")

        except Exception as e:
            # ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã¨ãã®å‡¦ç†
            print()
            print(f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {file_path.name}")
            print(f"ã‚¨ãƒ©ãƒ¼å†…å®¹: {str(e)}")
            print()
            print("ğŸ‘€ æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾…ã£ã¦ã„ã¾ã™...")

        finally:
            # å‡¦ç†ãŒçµ‚ã‚ã£ãŸã‚‰å‡¦ç†ä¸­ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
            # ï¼ˆfinally ã¯ã€ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã‚‚å¿…ãšå®Ÿè¡Œã•ã‚Œã‚‹ï¼‰
            self.processing_files.discard(str(file_path))


# ============================================================
# ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’çµ‚äº†ã™ã‚‹ãŸã‚ã®å‡¦ç†
# ============================================================

# ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ç¶ºéº—ã«çµ‚äº†ã•ã›ã‚‹ãŸã‚ã®å¤‰æ•°
should_exit = False


def signal_handler(sig, frame):
    """
    Ctrl+C ãŒæŠ¼ã•ã‚ŒãŸã¨ãã«å‘¼ã°ã‚Œã‚‹é–¢æ•°

    ã€ã‚·ã‚°ãƒŠãƒ«ã¨ã¯ã€‘
    ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¸ã®ç‰¹åˆ¥ãªåˆå›³ã€‚Ctrl+Cã‚’æŠ¼ã™ã¨ã€ŒSIGINTã€ã¨ã„ã†
    ã‚·ã‚°ãƒŠãƒ«ãŒãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«é€ã‚‰ã‚Œã‚‹ã€‚

    å¼•æ•°:
        sig: ã‚·ã‚°ãƒŠãƒ«ã®ç¨®é¡
        frame: ç¾åœ¨ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®çŠ¶æ…‹ï¼ˆä½¿ã‚ãªã„ï¼‰
    """
    global should_exit  # ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆãƒ—ãƒ­ã‚°ãƒ©ãƒ å…¨ä½“ã§ä½¿ãˆã‚‹å¤‰æ•°ï¼‰

    print()
    print()
    print("=" * 70)
    print("â¹ï¸  åœæ­¢ä¿¡å·ã‚’å—ä¿¡ã—ã¾ã—ãŸ (Ctrl+C)")
    print("=" * 70)
    print("ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’çµ‚äº†ã—ã¦ã„ã¾ã™...")
    print()

    should_exit = True  # çµ‚äº†ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹


# ============================================================
# ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼ˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®æœ¬ä½“ï¼‰
# ============================================================

def main():
    """
    ãƒ¡ã‚¤ãƒ³é–¢æ•°ï¼ˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒèµ·å‹•ã—ãŸã‚‰æœ€åˆã«å®Ÿè¡Œã•ã‚Œã‚‹ï¼‰
    """

    # ============================================================
    # ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã®è¨­å®š
    # ============================================================
    # ï¼ˆãƒ—ãƒ­ã‚°ãƒ©ãƒ å®Ÿè¡Œæ™‚ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰

    parser = argparse.ArgumentParser(
        description="ğŸ¤ Whisperè‡ªå‹•æ–‡å­—èµ·ã“ã—ã‚·ã‚¹ãƒ†ãƒ \n"
                    "inputãƒ•ã‚©ãƒ«ãƒ€ã‚’ç›£è¦–ã—ã¦ã€æ–°ã—ã„.m4aãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•çš„ã«æ–‡å­—èµ·ã“ã—ã—ã¾ã™",
        formatter_class=argparse.RawDescriptionHelpFormatter
    )

    # --model ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆãƒ¢ãƒ‡ãƒ«ã®ç¨®é¡ã‚’é¸ã¹ã‚‹ï¼‰
    parser.add_argument(
        "--model",
        type=str,
        default="base",
        choices=["tiny", "base", "small", "medium", "large"],
        help="Whisperãƒ¢ãƒ‡ãƒ«ã®ã‚µã‚¤ã‚º (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: base)\n"
             "tiny: ä¸€ç•ªé€Ÿã„ã‘ã©ç²¾åº¦ä½ã‚\n"
             "base: ãƒãƒ©ãƒ³ã‚¹å‹ï¼ˆæ¨å¥¨ï¼‰\n"
             "small: ã‚„ã‚„é«˜ç²¾åº¦\n"
             "medium: é«˜ç²¾åº¦ã ã‘ã©é…ã„\n"
             "large: æœ€é«˜ç²¾åº¦ã ã‘ã©ã¨ã¦ã‚‚é…ã„"
    )

    # --language ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆè¨€èªã‚’é¸ã¹ã‚‹ï¼‰
    parser.add_argument(
        "--language",
        type=str,
        default="ja",
        help="è¨€èªã‚³ãƒ¼ãƒ‰ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ja)\n"
             "ja: æ—¥æœ¬èª\n"
             "en: è‹±èª\n"
             "ãªã©"
    )

    # ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’è§£æï¼ˆèª­ã¿è¾¼ã‚€ï¼‰
    args = parser.parse_args()

    # ============================================================
    # åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    # ============================================================

    # input/output ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆï¼ˆãªã‘ã‚Œã°ï¼‰
    setup_directories()

    # çµ¶å¯¾ãƒ‘ã‚¹ã‚’å–å¾—ï¼ˆãƒ•ãƒ«ãƒ‘ã‚¹ã§è¡¨ç¤ºã™ã‚‹ï¼‰
    input_abs_path = Path(INPUT_DIR).resolve()
    output_abs_path = Path(OUTPUT_DIR).resolve()

    # èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    print()
    print("=" * 70)
    print("ğŸ¤ Whisperè‡ªå‹•æ–‡å­—èµ·ã“ã—ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•ã—ã¾ã—ãŸ")
    print("=" * 70)
    print(f"ğŸ“ ç›£è¦–ãƒ•ã‚©ãƒ«ãƒ€: {input_abs_path}")
    print(f"ğŸ“ å‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€: {output_abs_path}")
    print(f"ğŸ¤– ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«: {args.model}")
    print(f"ğŸŒ è¨€èª: {args.language}")
    print()
    print("ğŸ’¡ ä½¿ã„æ–¹:")
    print(f"   1. {INPUT_DIR}/ ãƒ•ã‚©ãƒ«ãƒ€ã« .m4a ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¦ãã ã•ã„")
    print("   2. è‡ªå‹•çš„ã«æ–‡å­—èµ·ã“ã—ãŒå§‹ã¾ã‚Šã¾ã™")
    print("   3. çµæœã¯ output/ ãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜ã•ã‚Œã¾ã™")
    print()
    print("â¸ï¸  åœæ­¢ã™ã‚‹ã«ã¯ Ctrl+C ã‚’æŠ¼ã—ã¦ãã ã•ã„")
    print("=" * 70)
    print()

    # Ctrl+C ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†ã‚’ç™»éŒ²
    signal.signal(signal.SIGINT, signal_handler)

    # ============================================================
    # ãƒ•ã‚©ãƒ«ãƒ€ç›£è¦–ã®é–‹å§‹
    # ============================================================

    # ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ ã‚’æ¤œçŸ¥ã™ã‚‹ä¿‚ï¼‰ã‚’ä½œæˆ
    event_handler = AudioFileHandler(
        model_name=args.model,
        language=args.language
    )

    # ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ¼ï¼ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’ç›£è¦–ã™ã‚‹ä¿‚ï¼‰ã‚’ä½œæˆ
    observer = Observer()

    # ã©ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç›£è¦–ã™ã‚‹ã‹è¨­å®š
    # recursive=False â†’ ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã¯ç›£è¦–ã—ãªã„
    observer.schedule(event_handler, INPUT_DIR, recursive=False)

    # ç›£è¦–ã‚’é–‹å§‹
    observer.start()
    print("ğŸ‘€ ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸ... æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾…ã£ã¦ã„ã¾ã™")
    print()

    try:
        # ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ï¼ˆãšã£ã¨å‹•ãç¶šã‘ã‚‹éƒ¨åˆ†ï¼‰
        while not should_exit:
            time.sleep(1)  # 1ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯

    except KeyboardInterrupt:
        # Ctrl+C ãŒæŠ¼ã•ã‚ŒãŸå ´åˆ
        pass

    finally:
        # ãƒ—ãƒ­ã‚°ãƒ©ãƒ çµ‚äº†æ™‚ã®å‡¦ç†
        print("ãƒ•ã‚©ãƒ«ãƒ€ç›£è¦–ã‚’åœæ­¢ã—ã¦ã„ã¾ã™...")
        observer.stop()      # ç›£è¦–ã‚’åœæ­¢
        observer.join()      # ç›£è¦–ã‚¹ãƒ¬ãƒƒãƒ‰ã®çµ‚äº†ã‚’å¾…ã¤

        print()
        print("=" * 70)
        print("ğŸ‘‹ ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’çµ‚äº†ã—ã¾ã—ãŸ")
        print("=" * 70)
        print()


# ============================================================
# ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ï¼‰
# ============================================================

if __name__ == "__main__":
    """
    ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒç›´æ¥å®Ÿè¡Œã•ã‚ŒãŸã¨ãã ã‘ main() ã‚’å®Ÿè¡Œã™ã‚‹

    ã€ãªãœå¿…è¦ï¼Ÿã€‘
    ä»–ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰importã•ã‚ŒãŸã¨ãã¯å®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã€‚
    """
    main()
